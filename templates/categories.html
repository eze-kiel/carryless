{{define "categories.html"}}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{.Title}}</title>
    <link rel="icon" type="image/svg+xml" href="/static/favicon.svg">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="/static/css/style.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    {{template "header" .}}

    <main class="main">
        {{if .Error}}
            <div class="alert alert-error">{{.Error}}</div>
        {{end}}
        <!-- Category deletion feedback messages -->
        <script>
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('success') === 'deleted') {
                document.addEventListener('DOMContentLoaded', function() {
                    const alert = document.createElement('div');
                    alert.className = 'alert alert-success';
                    alert.textContent = 'Category successfully deleted!';
                    document.querySelector('.page-header').after(alert);
                });
            }
            
            const error = urlParams.get('error');
            if (error) {
                document.addEventListener('DOMContentLoaded', function() {
                    const alert = document.createElement('div');
                    alert.className = 'alert alert-error';
                    let message = '';
                    switch(error) {
                        case 'invalid_id': message = 'Delete failed. Invalid category ID.'; break;
                        case 'category_has_items': message = 'Cannot delete category. It contains items that must be deleted or moved first.'; break;
                        case 'category_not_found': message = 'Delete failed. Category not found.'; break;
                        case 'delete_failed': message = 'Delete failed. Could not delete category.'; break;
                        default: message = 'An error occurred.';
                    }
                    alert.textContent = message;
                    document.querySelector('.page-header').after(alert);
                });
            }
        </script>
        
        <div class="page-header">
            <h1>Categories</h1>
            <a href="/categories/new" class="btn btn-primary">Add Category</a>
        </div>

        {{if .Categories}}
            <div class="categories-table">
                <table>
                    <thead>
                        <tr>
                            <th>Category Name</th>
                        </tr>
                    </thead>
                    <tbody>
                        {{range .Categories}}
                            <tr class="clickable-row" data-id="{{.ID}}" data-name="{{.Name}}">
                                <td>{{.Name}}</td>
                            </tr>
                        {{end}}
                    </tbody>
                </table>
            </div>
        {{else}}
            <div class="empty-state">
                <p>No categories yet. Create your first category to organize your gear.</p>
            </div>
        {{end}}

        <!-- Category Edit/Delete Modal -->
        <div id="categoryModal" class="modal" style="display: none;">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>Edit Category</h3>
                    <button type="button" class="modal-close" onclick="hideCategoryModal()">&times;</button>
                </div>
                <div class="modal-body">
                    <form id="editCategoryForm" action="" method="POST">
                        <input type="hidden" name="csrf_token" value="{{.CSRFToken}}">
                        <div class="form-group">
                            <label for="categoryName">Category Name</label>
                            <input type="text" id="categoryName" name="name" required>
                        </div>
                        <div class="form-actions">
                            <button type="submit" class="btn btn-primary">Save</button>
                            <button type="button" class="btn btn-danger" onclick="showDeleteConfirmation()">Delete</button>
                        </div>
                    </form>
                </div>
                <div id="deleteConfirmation" style="display: none;">
                    <div class="modal-body">
                        <div id="deleteWarningContent"></div>
                        <div class="form-actions">
                            <button type="button" class="btn btn-secondary" onclick="hideDeleteConfirmation()">Cancel</button>
                            <button type="button" id="confirmDeleteBtn" class="btn btn-danger" onclick="confirmCategoryDelete()">Delete</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

<style>
.clickable-row {
    cursor: pointer;
}
.clickable-row:hover {
    background-color: var(--color-gray-50);
}
.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1rem 1.5rem;
    border-bottom: 1px solid var(--color-gray-200);
}
.modal-header h3 {
    margin: 0;
}
.modal-close {
    background: none;
    border: none;
    font-size: 1.5rem;
    cursor: pointer;
    color: var(--color-gray-500);
    padding: 0;
    line-height: 1;
}
.modal-close:hover {
    color: var(--color-gray-700);
}
.modal-body {
    padding: 1.5rem;
}
#deleteConfirmation {
    border-top: 1px solid var(--color-gray-200);
}
</style>

<script>
let currentCategoryId = null;
let forceCategoryDelete = false;
const categoriesPageCsrfToken = '{{.CSRFToken}}';

// Make rows clickable
document.querySelectorAll('.clickable-row').forEach(row => {
    row.addEventListener('click', function() {
        const id = this.dataset.id;
        const name = this.dataset.name;
        openCategoryModal(id, name);
    });
});

function openCategoryModal(id, name) {
    currentCategoryId = id;
    document.getElementById('categoryName').value = name;
    document.getElementById('editCategoryForm').action = `/categories/${id}`;
    document.getElementById('deleteConfirmation').style.display = 'none';
    document.getElementById('editCategoryForm').style.display = 'block';
    document.getElementById('categoryModal').style.display = 'flex';
}

function hideCategoryModal() {
    document.getElementById('categoryModal').style.display = 'none';
    currentCategoryId = null;
}

async function showDeleteConfirmation() {
    document.getElementById('editCategoryForm').style.display = 'none';

    try {
        const response = await fetch(`/categories/${currentCategoryId}/items`);
        const data = await response.json();

        const warningContent = document.getElementById('deleteWarningContent');
        const confirmBtn = document.getElementById('confirmDeleteBtn');

        if (data.items && data.items.length > 0) {
            // Escape item names to prevent XSS
            const escapedItems = data.items.map(item => {
                const div = document.createElement('div');
                div.textContent = item.name;
                return div.innerHTML;
            });
            warningContent.innerHTML = `
                <div class="alert alert-warning" style="margin-bottom: 1rem;">
                    <strong>Warning:</strong> This category contains ${data.items.length} item(s):
                </div>
                <ul style="margin: 0.75rem 0; padding-left: 1.5rem; max-height: 150px; overflow-y: auto;">
                    ${escapedItems.map(name => `<li>${name}</li>`).join('')}
                </ul>
                <p style="margin-top: 1rem;"><strong>Deleting this category will permanently delete all items above.</strong></p>
            `;
            confirmBtn.textContent = 'Delete Category and Items';
            forceCategoryDelete = true;
        } else {
            warningContent.innerHTML = `<p>Are you sure you want to delete this category?</p>`;
            confirmBtn.textContent = 'Delete';
            forceCategoryDelete = false;
        }
    } catch (error) {
        document.getElementById('deleteWarningContent').innerHTML = `<p>Are you sure you want to delete this category?</p>`;
        forceCategoryDelete = false;
    }

    document.getElementById('deleteConfirmation').style.display = 'block';
}

function hideDeleteConfirmation() {
    document.getElementById('deleteConfirmation').style.display = 'none';
    document.getElementById('editCategoryForm').style.display = 'block';
}

function confirmCategoryDelete() {
    const form = document.createElement('form');
    form.method = 'POST';
    form.action = `/categories/${currentCategoryId}/delete`;

    const csrfInput = document.createElement('input');
    csrfInput.type = 'hidden';
    csrfInput.name = 'csrf_token';
    csrfInput.value = categoriesPageCsrfToken;
    form.appendChild(csrfInput);

    if (forceCategoryDelete) {
        const forceInput = document.createElement('input');
        forceInput.type = 'hidden';
        forceInput.name = 'force';
        forceInput.value = 'true';
        form.appendChild(forceInput);
    }

    document.body.appendChild(form);
    form.submit();
}

// Close modal when clicking outside
document.getElementById('categoryModal').addEventListener('click', function(e) {
    if (e.target === this) {
        hideCategoryModal();
    }
});
</script>
    </main>

    <footer class="footer">
        <div class="footer-content">
            <p>Built with love by Hugo Blanc. Free and <a href="https://github.com/eze-kiel/carryless">open-source</a>, forever. <a href="https://ko-fi.com/carryless" class="donate-link" target="_blank" rel="noopener noreferrer">Support Carryless <i class="fas fa-heart"></i></a></p>
            <div class="legal-links">
                <a href="/terms">Terms of Service</a> | <a href="/privacy">Privacy Policy</a>
            </div>
            <div class="weight-unit-selector">
                <label for="weightUnitSelector">Units:</label>
                <select id="weightUnitSelector" onchange="changeWeightUnit(this.value)">
                    <option value="g">Grams</option>
                    <option value="oz">Ounces</option>
                </select>
            </div>
        </div>
    </footer>

    <script src="/static/js/app.js"></script>

<script>
</script>
</body>
</html>
{{end}}