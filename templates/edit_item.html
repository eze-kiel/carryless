{{define "edit_item.html"}}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{.Title}}</title>
    <link rel="icon" type="image/svg+xml" href="/static/favicon.svg">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="/static/css/style.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <header class="header">
        <nav class="nav">
            <div class="nav-brand">
                <a href="/">Carryless</a>
            </div>
            <div class="nav-links">
                {{if .User}}
                    <a href="/dashboard">Dashboard</a>
                    <div class="dropdown">
                        <button class="dropdown-toggle" type="button" aria-haspopup="true" aria-expanded="false">
                            Inventory
                            <svg class="dropdown-arrow" width="12" height="12" viewBox="0 0 12 12" fill="currentColor">
                                <path d="M2.5 4.5L6 8L9.5 4.5"></path>
                            </svg>
                        </button>
                        <div class="dropdown-menu">
                            <a href="/inventory" class="dropdown-item">Items</a>
                            <a href="/categories" class="dropdown-item">Categories</a>
                            <a href="/packs" class="dropdown-item">Packs</a>
                        </div>
                    </div>
                    {{if .User.IsAdmin}}
                        <a href="/admin">Admin</a>
                    {{end}}
                    <a href="/account">Account</a>
                    <form class="logout-form" action="/logout" method="POST">
                        <button type="submit" class="btn btn-secondary">Logout</button>
                    </form>
                {{else}}
                    <a href="/login">Login</a>
                    <a href="/register">Register</a>
                {{end}}
            </div>
        </nav>
    </header>

    <main class="main">
        {{if .Error}}
            <div class="alert alert-error">{{.Error}}</div>
        {{end}}
        
        <div class="page-header">
            <h1>Edit Item</h1>
            <a href="/inventory" class="btn btn-secondary">Back to Inventory</a>
        </div>

        {{if .Item}}
        <div class="form-container">
            <form action="/inventory/items/{{.Item.ID}}" method="POST" class="form">
                <input type="hidden" name="csrf_token" value="{{.CSRFToken}}">
                <div class="form-group">
                    <label for="name">Item Name *</label>
                    <input type="text" id="name" name="name" value="{{.Item.Name}}" required maxlength="200" placeholder="Enter item name">
                </div>
                
                <div class="form-group">
                    <label for="note">Description</label>
                    <textarea id="note" name="note" rows="3" placeholder="Add a description for this item">{{.Item.Note}}</textarea>
                </div>
                
                <div class="form-group">
                    <label for="category_name">Category *</label>
                    <div class="autocomplete-container">
                        <input type="text" id="category_name" name="category_name" required maxlength="100" 
                               placeholder="Type category name..." autocomplete="off" value="{{.Item.Category.Name}}">
                        <div id="category-suggestions" class="autocomplete-suggestions"></div>
                    </div>
                    <small class="form-help">Type to search existing categories or create a new one</small>
                </div>
                
                <div class="form-group">
                    <label for="weight_grams">Weight (grams) *</label>
                    <input type="number" id="weight_grams" name="weight_grams" value="{{.Item.WeightGrams}}" required min="0" placeholder="Enter weight in grams">
                </div>
                
                <div class="form-group checkbox-group">
                    <label class="checkbox-label">
                        <input type="checkbox" id="weight_to_verify" name="weight_to_verify"{{if .Item.WeightToVerify}} checked{{end}}>
                        <span class="checkbox-checkmark"></span>
                        Weight needs verification
                    </label>
                    <small class="form-help">Check this if the weight is estimated and needs to be verified later</small>
                </div>
                
                <div class="form-group">
                    <label for="price">Price (optional)</label>
                    <input type="number" id="price" name="price" value="{{if .Item.Price}}{{.Item.Price}}{{end}}" step="0.01" min="0" placeholder="Enter price">
                </div>
                
                <div class="form-actions">
                    <a href="/inventory" class="btn btn-secondary">Cancel</a>
                    <button type="submit" class="btn btn-primary">Update Item</button>
                </div>
            </form>
            
            <div class="danger-zone">
                <h3>Danger Zone</h3>
                <p>Deleting an item will remove it from all packs that contain it.</p>
                <form action="/inventory/items/{{.Item.ID}}/delete" method="POST" onsubmit="return confirm('Are you sure you want to delete this item? This action cannot be undone.')">
                    <input type="hidden" name="csrf_token" value="{{.CSRFToken}}">
                    <button type="submit" class="btn btn-danger">Delete Item</button>
                </form>
            </div>
        </div>
        {{end}}
    </main>

    <footer class="footer">
        <div class="footer-content">
            <p>Built with love by Serac Alpine Gear. Free and <a href="https://github.com/eze-kiel/carryless">open-source</a>, forever. <a href="https://ko-fi.com/seracalpinegear" class="donate-link" target="_blank" rel="noopener noreferrer">Donate <i class="fas fa-heart"></i></a></p>
            <div class="weight-unit-selector">
                <label for="weightUnitSelector">Units:</label>
                <select id="weightUnitSelector" onchange="changeWeightUnit(this.value)">
                    <option value="g">Grams</option>
                    <option value="oz">Ounces</option>
                </select>
            </div>
        </div>
    </footer>

    <script src="/static/js/app.js"></script>
    
    <style>
    /* Autocomplete Styles */
    .autocomplete-container {
        position: relative;
    }
    
    .autocomplete-suggestions {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: var(--color-white);
        border: 1px solid var(--color-gray-300);
        border-top: none;
        border-radius: 0 0 var(--radius-md) var(--radius-md);
        box-shadow: var(--shadow-lg);
        max-height: 200px;
        overflow-y: auto;
        z-index: 1000;
        display: none;
    }
    
    .autocomplete-suggestions.show {
        display: block;
    }
    
    .suggestion-item {
        padding: var(--space-3);
        cursor: pointer;
        transition: background-color var(--transition-fast);
        font-size: var(--font-size-sm);
    }
    
    .suggestion-item:hover,
    .suggestion-item.highlighted {
        background: var(--color-gray-50);
    }
    
    .suggestion-item.new-category {
        color: var(--color-primary);
        font-style: italic;
    }
    
    .suggestion-item.new-category:hover {
        background: var(--color-primary-light);
    }
    
    .form-help {
        display: block;
        margin-top: var(--space-1);
        font-size: var(--font-size-xs);
        color: var(--color-gray-500);
    }
    </style>
    
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        const categoryInput = document.getElementById('category_name');
        const suggestionsContainer = document.getElementById('category-suggestions');
        
        // Categories data from server
        const categories = [
            {{range .Categories}}
            {id: {{.ID}}, name: "{{.Name}}"},
            {{end}}
        ];
        
        let currentHighlight = -1;
        
        function showSuggestions(query) {
            if (!query) {
                hideSuggestions();
                return;
            }
            
            const filtered = categories.filter(cat => 
                cat.name.toLowerCase().includes(query.toLowerCase())
            );
            
            let html = '';
            
            // Add existing matching categories
            filtered.forEach(cat => {
                html += `<div class="suggestion-item" data-category-name="${cat.name}">${cat.name}</div>`;
            });
            
            // Add "Create new category" option if no case-insensitive match
            const exactMatch = filtered.find(cat => 
                cat.name.toLowerCase() === query.toLowerCase()
            );
            
            if (!exactMatch && query.trim()) {
                html += `<div class="suggestion-item new-category" data-category-name="${query}">Create "${query}"</div>`;
            }
            
            if (html) {
                suggestionsContainer.innerHTML = html;
                suggestionsContainer.classList.add('show');
                currentHighlight = -1;
                
                // Add click handlers
                suggestionsContainer.querySelectorAll('.suggestion-item').forEach(item => {
                    item.addEventListener('click', () => {
                        selectCategory(item.dataset.categoryName);
                    });
                });
            } else {
                hideSuggestions();
            }
        }
        
        function hideSuggestions() {
            suggestionsContainer.classList.remove('show');
            currentHighlight = -1;
        }
        
        function selectCategory(categoryName) {
            categoryInput.value = categoryName;
            hideSuggestions();
            categoryInput.focus();
        }
        
        function highlightSuggestion(direction) {
            const items = suggestionsContainer.querySelectorAll('.suggestion-item');
            if (items.length === 0) return;
            
            // Remove current highlight
            if (currentHighlight >= 0 && currentHighlight < items.length) {
                items[currentHighlight].classList.remove('highlighted');
            }
            
            // Update highlight index
            if (direction === 'down') {
                currentHighlight = (currentHighlight + 1) % items.length;
            } else if (direction === 'up') {
                currentHighlight = currentHighlight <= 0 ? items.length - 1 : currentHighlight - 1;
            }
            
            // Add new highlight
            if (currentHighlight >= 0 && currentHighlight < items.length) {
                items[currentHighlight].classList.add('highlighted');
            }
        }
        
        // Event listeners
        categoryInput.addEventListener('input', (e) => {
            showSuggestions(e.target.value);
        });
        
        categoryInput.addEventListener('keydown', (e) => {
            const isOpen = suggestionsContainer.classList.contains('show');
            
            if (e.key === 'ArrowDown') {
                e.preventDefault();
                if (isOpen) {
                    highlightSuggestion('down');
                } else {
                    showSuggestions(categoryInput.value);
                }
            } else if (e.key === 'ArrowUp') {
                e.preventDefault();
                if (isOpen) {
                    highlightSuggestion('up');
                }
            } else if (e.key === 'Enter') {
                if (isOpen && currentHighlight >= 0) {
                    e.preventDefault();
                    const items = suggestionsContainer.querySelectorAll('.suggestion-item');
                    if (items[currentHighlight]) {
                        selectCategory(items[currentHighlight].dataset.categoryName);
                    }
                }
            } else if (e.key === 'Escape') {
                hideSuggestions();
            }
        });
        
        // Hide suggestions when clicking outside
        document.addEventListener('click', (e) => {
            if (!categoryInput.contains(e.target) && !suggestionsContainer.contains(e.target)) {
                hideSuggestions();
            }
        });
        
        categoryInput.addEventListener('focus', () => {
            if (categoryInput.value) {
                showSuggestions(categoryInput.value);
            }
        });
    });
    </script>
    
    <script>
    // Weight unit cookie management (for consistency across pages)
    function setCookie(name, value, days = 365) {
        const expires = new Date();
        expires.setTime(expires.getTime() + (days * 24 * 60 * 60 * 1000));
        document.cookie = name + '=' + value + ';expires=' + expires.toUTCString() + ';path=/';
    }
    
    function getCookie(name) {
        const nameEQ = name + "=";
        const ca = document.cookie.split(';');
        for (let i = 0; i < ca.length; i++) {
            let c = ca[i];
            while (c.charAt(0) === ' ') c = c.substring(1, c.length);
            if (c.indexOf(nameEQ) === 0) return c.substring(nameEQ.length, c.length);
        }
        return null;
    }
    
    function isValidWeightUnit(unit) {
        return unit === 'g' || unit === 'oz';
    }
    
    function changeWeightUnit(unit) {
        if (!isValidWeightUnit(unit)) {
            console.warn('Invalid weight unit:', unit, 'Defaulting to grams');
            unit = 'g';
        }
        setCookie('weightUnit', unit);
    }
    
    // Initialize unit preference on page load
    document.addEventListener('DOMContentLoaded', function() {
        let savedUnit = getCookie('weightUnit') || 'g';
        
        if (!isValidWeightUnit(savedUnit)) {
            savedUnit = 'g';
            setCookie('weightUnit', 'g');
        }
        
        const selector = document.getElementById('weightUnitSelector');
        if (selector) {
            selector.value = savedUnit;
        }
    });
    </script>

<script>
// Dropdown functionality
document.addEventListener('DOMContentLoaded', function() {
    const dropdown = document.querySelector('.nav-links .dropdown');
    const dropdownToggle = document.querySelector('.nav-links .dropdown-toggle');
    const dropdownMenu = document.querySelector('.nav-links .dropdown-menu');
    
    if (dropdown && dropdownToggle && dropdownMenu) {
        // Toggle dropdown on button click
        dropdownToggle.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            dropdown.classList.toggle('active');
        });
        
        // Close dropdown when clicking outside
        document.addEventListener('click', function(e) {
            if (!dropdown.contains(e.target)) {
                dropdown.classList.remove('active');
            }
        });
        
        // Close dropdown on escape key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                dropdown.classList.remove('active');
                dropdownToggle.focus();
            }
        });
        
        // Handle arrow keys for dropdown navigation
        dropdownToggle.addEventListener('keydown', function(e) {
            if (e.key === 'ArrowDown' || e.key === 'Enter' || e.key === ' ') {
                e.preventDefault();
                dropdown.classList.add('active');
                const firstItem = dropdownMenu.querySelector('.dropdown-item');
                if (firstItem) {
                    firstItem.focus();
                }
            }
        });
        
        // Handle navigation within dropdown
        const dropdownItems = dropdownMenu.querySelectorAll('.dropdown-item');
        dropdownItems.forEach((item, index) => {
            item.addEventListener('keydown', function(e) {
                if (e.key === 'ArrowDown') {
                    e.preventDefault();
                    const nextIndex = (index + 1) % dropdownItems.length;
                    dropdownItems[nextIndex].focus();
                } else if (e.key === 'ArrowUp') {
                    e.preventDefault();
                    const prevIndex = (index - 1 + dropdownItems.length) % dropdownItems.length;
                    dropdownItems[prevIndex].focus();
                } else if (e.key === 'Escape') {
                    e.preventDefault();
                    dropdown.classList.remove('active');
                    dropdownToggle.focus();
                }
            });
        });
    }
});
</script>
</body>
</html>
{{end}}