{{define "edit_item.html"}}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{.Title}}</title>
    <link rel="icon" type="image/svg+xml" href="/static/favicon.svg">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="/static/css/style.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    {{template "header" .}}

    <main class="main">
        {{if .Error}}
            <div class="alert alert-error">{{.Error}}</div>
        {{end}}
        
        <div class="page-header">
            <h1>Edit Item</h1>
            <a href="/inventory" class="btn btn-secondary">Back to Inventory</a>
        </div>

        {{if .Item}}
        <div class="form-container">
            <form action="/inventory/items/{{.Item.ID}}" method="POST" class="form">
                <input type="hidden" name="csrf_token" value="{{.CSRFToken}}">

                <div class="form-row">
                    <div class="form-group" style="flex: 1;">
                        <label for="name">Item Name *</label>
                        <input type="text" id="name" name="name" value="{{.Item.Name}}" required maxlength="200" placeholder="Enter item name">
                    </div>
                    <div class="form-group" style="flex: 1;">
                        <label for="category_name">Category *</label>
                        <div class="autocomplete-container">
                            <input type="text" id="category_name" name="category_name" required maxlength="100"
                                   placeholder="Type category name..." autocomplete="off" value="{{.Item.Category.Name}}">
                            <div id="category-suggestions" class="autocomplete-suggestions"></div>
                        </div>
                        <small class="form-help">Type to search existing categories or create a new one</small>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group" style="flex: 1;">
                        <label for="brand">Brand</label>
                        <input type="text" id="brand" name="brand" maxlength="100" placeholder="Enter brand name" value="{{if .Item.Brand}}{{.Item.Brand}}{{end}}">
                    </div>
                    <div class="form-group" style="flex: 1;">
                        <label for="model">Model</label>
                        <input type="text" id="model" name="model" maxlength="100" placeholder="Enter model name" value="{{if .Item.Model}}{{.Item.Model}}{{end}}">
                    </div>
                </div>

                <div class="form-group">
                    <label for="note">Notes</label>
                    <textarea id="note" name="note" rows="3" placeholder="Add notes for this item">{{.Item.Note}}</textarea>
                </div>

                <div class="form-group">
                    <label for="weight_grams">Weight (grams) *</label>
                    <input type="number" id="weight_grams" name="weight_grams" value="{{.Item.WeightGrams}}" required min="0" placeholder="Enter weight in grams">
                </div>

                <div class="form-group checkbox-group">
                    <label class="checkbox-label">
                        <input type="checkbox" id="weight_to_verify" name="weight_to_verify"{{if .Item.WeightToVerify}} checked{{end}}>
                        <span class="checkbox-checkmark"></span>
                        Weight needs verification
                    </label>
                    <small class="form-help">Check this if the weight is estimated and needs to be verified later</small>
                </div>

                <div class="form-group">
                    <label for="price">Price (optional)</label>
                    <input type="number" id="price" name="price" value="{{if .Item.Price}}{{.Item.Price}}{{end}}" step="0.01" min="0" placeholder="Enter price">
                </div>

                <div class="form-group">
                    <label for="purchase_date">Purchased (optional)</label>
                    <input type="date" id="purchase_date" name="purchase_date" value="{{if .Item.PurchaseDate}}{{.Item.PurchaseDate.Format "2006-01-02"}}{{end}}">
                </div>

                <div class="form-row">
                    <div class="form-group" style="flex: 2;">
                        <label for="capacity">Capacity (optional)</label>
                        <input type="number" id="capacity" name="capacity" step="0.01" min="0" placeholder="e.g., 1000" value="{{if .Item.Capacity}}{{.Item.Capacity}}{{end}}">
                    </div>
                    <div class="form-group" style="flex: 1;">
                        <label for="capacity_unit">Unit</label>
                        <select id="capacity_unit" name="capacity_unit">
                            <option value="">--</option>
                            <option value="mL"{{if .Item.CapacityUnit}}{{if eq (deref .Item.CapacityUnit) "mL"}} selected{{end}}{{end}}>mL</option>
                            <option value="L"{{if .Item.CapacityUnit}}{{if eq (deref .Item.CapacityUnit) "L"}} selected{{end}}{{end}}>L</option>
                            <option value="fl-oz"{{if .Item.CapacityUnit}}{{if eq (deref .Item.CapacityUnit) "fl-oz"}} selected{{end}}{{end}}>fl-oz</option>
                            <option value="mAh"{{if .Item.CapacityUnit}}{{if eq (deref .Item.CapacityUnit) "mAh"}} selected{{end}}{{end}}>mAh</option>
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <label for="link">Product Link (optional)</label>
                    <input type="url" id="link" name="link" maxlength="500" placeholder="https://..." value="{{if .Item.Link}}{{.Item.Link}}{{end}}">
                </div>

                <!-- Linked Items Section -->
                <div class="linked-items-section">
                    <div class="linked-items-header">
                        <label>Linked Items <span class="tooltip-icon" title="When you add this item to a pack, its linked items will be automatically added too."><i class="fas fa-question-circle"></i></span></label>
                        <button type="button" class="btn btn-sm btn-secondary" onclick="showAddLinkedItemPicker()">+ Add</button>
                    </div>
                    <div id="linkedItemsList" class="linked-items-list">
                        <span class="loading-text">Loading...</span>
                    </div>
                    <div id="linkedItemPicker" class="linked-item-picker" style="display: none;">
                        <input type="text" id="linkedItemSearch" class="form-control" placeholder="Search for item to link...">
                        <div id="linkedItemSuggestions" class="linked-item-suggestions"></div>
                    </div>
                </div>

                <div class="form-actions">
                    <a href="/inventory" class="btn btn-secondary">Cancel</a>
                    <button type="submit" class="btn btn-primary">Update Item</button>
                </div>
            </form>
            
            <div class="danger-zone">
                <h3>Danger Zone</h3>
                <p>Deleting an item will remove it from all packs that contain it.</p>
                <form action="/inventory/items/{{.Item.ID}}/delete" method="POST" onsubmit="return confirm('Are you sure you want to delete this item? This action cannot be undone.')">
                    <input type="hidden" name="csrf_token" value="{{.CSRFToken}}">
                    <button type="submit" class="btn btn-danger">Delete Item</button>
                </form>
            </div>
        </div>
        {{end}}
    </main>

    <footer class="footer">
        <div class="footer-content">
            <p>Built with love by Hugo Blanc. Free and <a href="https://github.com/eze-kiel/carryless">open-source</a>, forever. <a href="https://ko-fi.com/carryless" class="donate-link" target="_blank" rel="noopener noreferrer">Support Carryless <i class="fas fa-heart"></i></a></p>
            <div class="legal-links">
                <a href="/terms">Terms of Service</a> | <a href="/privacy">Privacy Policy</a>
            </div>
            <div class="weight-unit-selector">
                <label for="weightUnitSelector">Units:</label>
                <select id="weightUnitSelector" onchange="changeWeightUnit(this.value)">
                    <option value="g">Grams</option>
                    <option value="oz">Ounces</option>
                </select>
            </div>
        </div>
    </footer>

    <script src="/static/js/app.js"></script>
    
    <style>
    /* Autocomplete Styles */
    .autocomplete-container {
        position: relative;
    }
    
    .autocomplete-suggestions {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: var(--color-white);
        border: 1px solid var(--color-gray-300);
        border-top: none;
        border-radius: 0 0 var(--radius-md) var(--radius-md);
        box-shadow: var(--shadow-lg);
        max-height: 200px;
        overflow-y: auto;
        z-index: 1000;
        display: none;
    }
    
    .autocomplete-suggestions.show {
        display: block;
    }
    
    .suggestion-item {
        padding: var(--space-3);
        cursor: pointer;
        transition: background-color var(--transition-fast);
        font-size: var(--font-size-sm);
    }
    
    .suggestion-item:hover,
    .suggestion-item.highlighted {
        background: var(--color-gray-50);
    }
    
    .suggestion-item.new-category {
        color: var(--color-primary);
        font-style: italic;
    }
    
    .suggestion-item.new-category:hover {
        background: var(--color-primary-light);
    }
    
    .form-help {
        display: block;
        margin-top: var(--space-1);
        font-size: var(--font-size-xs);
        color: var(--color-gray-500);
    }

    .form-container {
        max-width: 700px;
    }

    .form-row {
        display: flex;
        gap: var(--space-4);
    }

    .form-row .form-group {
        margin-bottom: var(--space-4);
    }

    /* Linked Items Styles */
    .linked-items-section {
        margin-bottom: var(--space-4);
    }

    .linked-items-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.5rem;
    }

    .linked-items-header label {
        font-weight: 500;
        color: var(--color-gray-700);
        margin-bottom: 0;
    }

    .linked-items-header .btn-sm {
        padding: 0.25rem 0.5rem;
        font-size: 0.75rem;
    }

    .linked-items-list {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        min-height: 24px;
    }

    .linked-item-tag {
        display: inline-flex;
        align-items: center;
        gap: 0.25rem;
        padding: 0.25rem 0.5rem;
        background: #fef3c7;
        color: #92400e;
        border-radius: var(--radius-sm);
        font-size: 0.8rem;
    }

    .linked-item-remove {
        background: none;
        border: none;
        color: #92400e;
        cursor: pointer;
        font-size: 1rem;
        line-height: 1;
        padding: 0;
        margin-left: 0.25rem;
    }

    .linked-item-remove:hover {
        color: #78350f;
    }

    .linked-item-picker {
        margin-top: 0.75rem;
    }

    .linked-item-picker input {
        width: 100%;
        margin-bottom: 0.5rem;
    }

    .linked-item-suggestions {
        max-height: 200px;
        overflow-y: auto;
        border: 1px solid var(--color-gray-200);
        border-radius: var(--radius-sm);
        background: white;
    }

    .linked-item-suggestion {
        padding: 0.5rem 0.75rem;
        cursor: pointer;
        display: flex;
        flex-direction: column;
        border-bottom: 1px solid var(--color-gray-100);
    }

    .linked-item-suggestion:last-child {
        border-bottom: none;
    }

    .linked-item-suggestion:hover {
        background: var(--color-gray-50);
    }

    .linked-item-suggestion .suggestion-name {
        font-weight: 500;
    }

    .linked-item-suggestion .suggestion-meta {
        font-size: 0.75rem;
        color: var(--color-gray-500);
    }

    .linked-items-list .empty-text,
    .linked-items-list .loading-text,
    .linked-items-list .error-text {
        color: var(--color-gray-500);
        font-size: 0.875rem;
        font-style: italic;
    }

    .linked-item-suggestions .no-matches {
        padding: 0.5rem 0.75rem;
        color: var(--color-gray-500);
        font-size: 0.875rem;
    }

    .tooltip-icon {
        color: var(--color-gray-400);
        cursor: help;
        font-size: 0.8rem;
        margin-left: 0.25rem;
    }

    .tooltip-icon:hover {
        color: var(--color-gray-600);
    }
    </style>
    
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        const categoryInput = document.getElementById('category_name');
        const suggestionsContainer = document.getElementById('category-suggestions');
        
        // Categories data from server
        const categories = [
            {{range .Categories}}
            {id: {{.ID}}, name: "{{.Name}}"},
            {{end}}
        ];
        
        let currentHighlight = -1;
        
        function showSuggestions(query) {
            if (!query) {
                hideSuggestions();
                return;
            }
            
            const filtered = categories.filter(cat => 
                cat.name.toLowerCase().includes(query.toLowerCase())
            );
            
            let html = '';
            
            // Add existing matching categories
            filtered.forEach(cat => {
                html += `<div class="suggestion-item" data-category-name="${cat.name}">${cat.name}</div>`;
            });
            
            // Add "Create new category" option if no case-insensitive match
            const exactMatch = filtered.find(cat => 
                cat.name.toLowerCase() === query.toLowerCase()
            );
            
            if (!exactMatch && query.trim()) {
                html += `<div class="suggestion-item new-category" data-category-name="${query}">Create "${query}"</div>`;
            }
            
            if (html) {
                suggestionsContainer.innerHTML = html;
                suggestionsContainer.classList.add('show');
                currentHighlight = -1;
                
                // Add click handlers
                suggestionsContainer.querySelectorAll('.suggestion-item').forEach(item => {
                    item.addEventListener('click', () => {
                        selectCategory(item.dataset.categoryName);
                    });
                });
            } else {
                hideSuggestions();
            }
        }
        
        function hideSuggestions() {
            suggestionsContainer.classList.remove('show');
            currentHighlight = -1;
        }
        
        function selectCategory(categoryName) {
            categoryInput.value = categoryName;
            hideSuggestions();
            categoryInput.focus();
        }
        
        function highlightSuggestion(direction) {
            const items = suggestionsContainer.querySelectorAll('.suggestion-item');
            if (items.length === 0) return;
            
            // Remove current highlight
            if (currentHighlight >= 0 && currentHighlight < items.length) {
                items[currentHighlight].classList.remove('highlighted');
            }
            
            // Update highlight index
            if (direction === 'down') {
                currentHighlight = (currentHighlight + 1) % items.length;
            } else if (direction === 'up') {
                currentHighlight = currentHighlight <= 0 ? items.length - 1 : currentHighlight - 1;
            }
            
            // Add new highlight
            if (currentHighlight >= 0 && currentHighlight < items.length) {
                items[currentHighlight].classList.add('highlighted');
            }
        }
        
        // Event listeners
        categoryInput.addEventListener('input', (e) => {
            showSuggestions(e.target.value);
        });
        
        categoryInput.addEventListener('keydown', (e) => {
            const isOpen = suggestionsContainer.classList.contains('show');
            
            if (e.key === 'ArrowDown') {
                e.preventDefault();
                if (isOpen) {
                    highlightSuggestion('down');
                } else {
                    showSuggestions(categoryInput.value);
                }
            } else if (e.key === 'ArrowUp') {
                e.preventDefault();
                if (isOpen) {
                    highlightSuggestion('up');
                }
            } else if (e.key === 'Enter') {
                if (isOpen && currentHighlight >= 0) {
                    e.preventDefault();
                    const items = suggestionsContainer.querySelectorAll('.suggestion-item');
                    if (items[currentHighlight]) {
                        selectCategory(items[currentHighlight].dataset.categoryName);
                    }
                }
            } else if (e.key === 'Escape') {
                hideSuggestions();
            }
        });
        
        // Hide suggestions when clicking outside
        document.addEventListener('click', (e) => {
            if (!categoryInput.contains(e.target) && !suggestionsContainer.contains(e.target)) {
                hideSuggestions();
            }
        });
        
        categoryInput.addEventListener('focus', () => {
            if (categoryInput.value) {
                showSuggestions(categoryInput.value);
            }
        });
    });
    </script>

    <script>
    // Linked Items Management
    const currentItemId = {{.Item.ID}};
    const editPageCsrfToken = '{{.CSRFToken}}';

    // Items data for picker (excluding current item)
    const allItems = [
        {{range .Items}}
        {{if ne .ID $.Item.ID}}
        {id: {{.ID}}, name: "{{.Name}}", category: "{{.Category.Name}}", weight: {{.WeightGrams}}},
        {{end}}
        {{end}}
    ];

    // Load linked items on page load
    document.addEventListener('DOMContentLoaded', function() {
        loadLinkedItems();
    });

    async function loadLinkedItems() {
        const listEl = document.getElementById('linkedItemsList');
        listEl.innerHTML = '<span class="loading-text">Loading...</span>';

        try {
            const response = await fetch(`/api/items/${currentItemId}/links`, {
                headers: {'X-CSRF-Token': editPageCsrfToken}
            });
            if (!response.ok) throw new Error('Failed to load links');
            const data = await response.json();

            if (data.links && data.links.length > 0) {
                listEl.innerHTML = data.links.map(link => {
                    const item = link.linked_item;
                    const brandModel = [item.brand, item.model].filter(Boolean).join(' ');
                    const displayName = brandModel ? `${item.name} (${brandModel})` : item.name;
                    return `
                    <div class="linked-item-tag">
                        <span>${displayName}</span>
                        <button type="button" class="linked-item-remove" onclick="removeLinkedItem(${link.linked_item_id})">&times;</button>
                    </div>
                `}).join('');
            } else {
                listEl.innerHTML = '<span class="empty-text">No linked items</span>';
            }
        } catch (err) {
            listEl.innerHTML = '<span class="error-text">Failed to load linked items</span>';
        }
    }

    function showAddLinkedItemPicker() {
        const picker = document.getElementById('linkedItemPicker');
        const searchInput = document.getElementById('linkedItemSearch');
        picker.style.display = 'block';
        searchInput.value = '';
        searchInput.focus();
        document.getElementById('linkedItemSuggestions').innerHTML = '';
    }

    document.getElementById('linkedItemSearch')?.addEventListener('input', function(e) {
        const query = e.target.value.toLowerCase().trim();
        const suggestionsDiv = document.getElementById('linkedItemSuggestions');

        if (query.length < 2) {
            suggestionsDiv.innerHTML = '';
            return;
        }

        const matches = allItems.filter(item =>
            item.name.toLowerCase().includes(query)
        ).slice(0, 5);

        if (matches.length === 0) {
            suggestionsDiv.innerHTML = '<div class="no-matches">No matching items</div>';
            return;
        }

        suggestionsDiv.innerHTML = matches.map(item => `
            <div class="linked-item-suggestion" onclick="addLinkedItem(${item.id})">
                <span class="suggestion-name">${item.name}</span>
                <span class="suggestion-meta">${item.category} - ${item.weight}g</span>
            </div>
        `).join('');
    });

    async function addLinkedItem(linkedItemId) {
        try {
            const response = await fetch(`/api/items/${currentItemId}/links`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRF-Token': editPageCsrfToken
                },
                body: JSON.stringify({linked_item_id: linkedItemId})
            });

            if (!response.ok) {
                const data = await response.json();
                alert(data.error || 'Failed to add linked item');
                return;
            }

            // Reload linked items and hide picker
            loadLinkedItems();
            document.getElementById('linkedItemPicker').style.display = 'none';
            document.getElementById('linkedItemSearch').value = '';
        } catch (err) {
            alert('Failed to add linked item');
        }
    }

    async function removeLinkedItem(linkedItemId) {
        try {
            const response = await fetch(`/api/items/${currentItemId}/links/${linkedItemId}`, {
                method: 'DELETE',
                headers: {'X-CSRF-Token': editPageCsrfToken}
            });

            if (!response.ok) {
                const data = await response.json();
                alert(data.error || 'Failed to remove linked item');
                return;
            }

            // Reload linked items
            loadLinkedItems();
        } catch (err) {
            alert('Failed to remove linked item');
        }
    }
    </script>
    
    <script>
    // Weight unit cookie management (for consistency across pages)
    function setCookie(name, value, days = 365) {
        const expires = new Date();
        expires.setTime(expires.getTime() + (days * 24 * 60 * 60 * 1000));
        document.cookie = name + '=' + value + ';expires=' + expires.toUTCString() + ';path=/';
    }
    
    function getCookie(name) {
        const nameEQ = name + "=";
        const ca = document.cookie.split(';');
        for (let i = 0; i < ca.length; i++) {
            let c = ca[i];
            while (c.charAt(0) === ' ') c = c.substring(1, c.length);
            if (c.indexOf(nameEQ) === 0) return c.substring(nameEQ.length, c.length);
        }
        return null;
    }
    
    function isValidWeightUnit(unit) {
        return unit === 'g' || unit === 'oz';
    }
    
    function changeWeightUnit(unit) {
        if (!isValidWeightUnit(unit)) {
            console.warn('Invalid weight unit:', unit, 'Defaulting to grams');
            unit = 'g';
        }
        setCookie('weightUnit', unit);
    }
    
    // Initialize unit preference on page load
    document.addEventListener('DOMContentLoaded', function() {
        let savedUnit = getCookie('weightUnit') || 'g';
        
        if (!isValidWeightUnit(savedUnit)) {
            savedUnit = 'g';
            setCookie('weightUnit', 'g');
        }
        
        const selector = document.getElementById('weightUnitSelector');
        if (selector) {
            selector.value = savedUnit;
        }
    });
    </script>

<script>
// Dropdown functionality
document.addEventListener('DOMContentLoaded', function() {
    const dropdown = document.querySelector('.nav-links .dropdown');
    const dropdownToggle = document.querySelector('.nav-links .dropdown-toggle');
    const dropdownMenu = document.querySelector('.nav-links .dropdown-menu');
    
    if (dropdown && dropdownToggle && dropdownMenu) {
        // Toggle dropdown on button click
        dropdownToggle.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            dropdown.classList.toggle('active');
        });
        
        // Close dropdown when clicking outside
        document.addEventListener('click', function(e) {
            if (!dropdown.contains(e.target)) {
                dropdown.classList.remove('active');
            }
        });
        
        // Close dropdown on escape key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                dropdown.classList.remove('active');
                dropdownToggle.focus();
            }
        });
        
        // Handle arrow keys for dropdown navigation
        dropdownToggle.addEventListener('keydown', function(e) {
            if (e.key === 'ArrowDown' || e.key === 'Enter' || e.key === ' ') {
                e.preventDefault();
                dropdown.classList.add('active');
                const firstItem = dropdownMenu.querySelector('.dropdown-item');
                if (firstItem) {
                    firstItem.focus();
                }
            }
        });
        
        // Handle navigation within dropdown
        const dropdownItems = dropdownMenu.querySelectorAll('.dropdown-item');
        dropdownItems.forEach((item, index) => {
            item.addEventListener('keydown', function(e) {
                if (e.key === 'ArrowDown') {
                    e.preventDefault();
                    const nextIndex = (index + 1) % dropdownItems.length;
                    dropdownItems[nextIndex].focus();
                } else if (e.key === 'ArrowUp') {
                    e.preventDefault();
                    const prevIndex = (index - 1 + dropdownItems.length) % dropdownItems.length;
                    dropdownItems[prevIndex].focus();
                } else if (e.key === 'Escape') {
                    e.preventDefault();
                    dropdown.classList.remove('active');
                    dropdownToggle.focus();
                }
            });
        });
    }
});
</script>
</body>
</html>
{{end}}