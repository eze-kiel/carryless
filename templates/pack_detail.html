{{define "pack_detail.html"}}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{.Title}}</title>
    <link rel="stylesheet" href="/static/css/style.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <header class="header">
        <nav class="nav">
            <div class="nav-brand">
                <a href="/">Carryless</a>
            </div>
            <div class="nav-links">
                {{if .User}}
                    <a href="/dashboard">Dashboard</a>
                    <a href="/inventory">Inventory</a>
                    <a href="/categories">Categories</a>
                    <a href="/packs">Packs</a>
                    {{if .User.IsAdmin}}
                        <a href="/admin">Admin</a>
                    {{end}}
                    <a href="/account">Account</a>
                    <form class="logout-form" action="/logout" method="POST">
                        <button type="submit" class="btn btn-secondary">Logout</button>
                    </form>
                {{else}}
                    <a href="/login">Login</a>
                    <a href="/register">Register</a>
                {{end}}
            </div>
        </nav>
    </header>

    <main class="main">
        {{if .Error}}
            <div class="alert alert-error">{{.Error}}</div>
        {{end}}
<div class="pack-detail">
    <div class="pack-header">
        <div class="page-header">
            <h1>{{.Pack.Name}}</h1>
            <div>
                {{if .Pack.IsPublic}}
                    <a href="/public/packs/{{.Pack.ID}}" class="btn btn-secondary" target="_blank">Public View</a>
                {{end}}
            </div>
        </div>
        
        <div class="pack-stats">
            <div class="stat">
                <div class="stat-value">{{.TotalWeight}}g</div>
                <div class="stat-label">Pack Weight</div>
            </div>
            <div class="stat">
                <div class="stat-value">{{.TotalWornWeight}}g</div>
                <div class="stat-label">Worn Weight</div>
            </div>
            <div class="stat">
                <div class="stat-value">{{add .TotalWeight .TotalWornWeight}}g</div>
                <div class="stat-label">Total Weight</div>
            </div>
            <div class="stat">
                <div class="stat-value">{{len .Pack.Items}}</div>
                <div class="stat-label">Items</div>
            </div>
        </div>

        {{if .CategoryWeights}}
            <div class="chart-container">
                <canvas id="weightChart"></canvas>
            </div>
        {{end}}
    </div>

    <!-- Add Item Search -->
    <div class="add-item-search">
        <div class="search-container">
            <input type="text" id="addItemSearch" placeholder="Search and add items to pack..." autocomplete="off">
            <div id="itemSuggestions" class="autocomplete-suggestions"></div>
        </div>
    </div>

    {{if .Pack.Items}}
        {{$categoryWeights := .CategoryWeights}}
        {{$categoryWornWeights := .CategoryWornWeights}}
        {{range $category, $items := (groupByCategory .Pack.Items)}}
            <div class="category-section">
                <h3>{{$category}} ({{index $categoryWeights $category}}g{{if index $categoryWornWeights $category}} + {{index $categoryWornWeights $category}}g worn{{end}})</h3>
                <table>
                    <thead>
                        <tr>
                            <th>Item</th>
                            <th>Description</th>
                            <th>Weight</th>
                            <th>Qty</th>
                            <th>Worn</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {{range $items}}
                            <tr>
                                <td>{{.Item.Name}}</td>
                                <td>{{.Item.Note}}</td>
                                <td>{{.Item.WeightGrams}}g</td>
                                <td>{{.Count}}</td>
                                <td>
                                    {{if eq .Count 1}}
                                        <input type="checkbox" {{if .IsWorn}}checked{{end}} 
                                               onchange="toggleWorn(packId, {{.Item.ID}}, this.checked)">
                                    {{else}}
                                        <input type="number" min="0" max="{{.Count}}" value="{{.WornCount}}" 
                                               onchange="updateWornCount(packId, {{.Item.ID}}, this.value)"
                                               style="width: 60px;">
                                    {{end}}
                                </td>
                                <td>
                                    <div class="dropdown">
                                        <details>
                                            <summary>
                                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                    <circle cx="12" cy="12" r="1"></circle>
                                                    <circle cx="12" cy="5" r="1"></circle>
                                                    <circle cx="12" cy="19" r="1"></circle>
                                                </svg>
                                            </summary>
                                            <div class="dropdown-menu">
                                                <button type="button" class="dropdown-item dropdown-item-danger" 
                                                        onclick="removeFromPack(packId, {{.Item.ID}})">Remove</button>
                                            </div>
                                        </details>
                                    </div>
                                </td>
                            </tr>
                        {{end}}
                    </tbody>
                </table>
            </div>
        {{end}}
    {{else}}
        <div class="empty-state">
            <p>No items in this pack yet. Use the search above to add items.</p>
        </div>
    {{end}}

</div>

<script>
let csrfToken = '';
const packId = '{{.Pack.ID}}';

async function fetchCSRFToken() {
    try {
        const response = await fetch('/api/csrf-token');
        const data = await response.json();
        csrfToken = data.token;
    } catch (error) {
        console.error('Failed to fetch CSRF token:', error);
    }
}

// Available items data for autocomplete
const availableItems = [
    {{range .Items}}
    {
        id: {{.ID}},
        name: "{{.Name}}",
        description: "{{.Note}}",
        category: "{{.Category.Name}}",
        weight: {{.WeightGrams}},
        inPack: {{if index $.ItemsInPack .ID}}true{{else}}false{{end}}
    },
    {{end}}
];

function setupItemSearch() {
    const searchInput = document.getElementById('addItemSearch');
    const suggestionsDiv = document.getElementById('itemSuggestions');
    
    if (!searchInput || !suggestionsDiv) return;
    
    searchInput.addEventListener('input', function(e) {
        const query = e.target.value.toLowerCase().trim();
        
        if (query.length < 2) {
            suggestionsDiv.style.display = 'none';
            return;
        }
        
        const matches = availableItems.filter(item => 
            item.name.toLowerCase().includes(query) || 
            item.description.toLowerCase().includes(query)
        ).slice(0, 8); // Limit to 8 suggestions
        
        if (matches.length === 0) {
            suggestionsDiv.style.display = 'none';
            return;
        }
        
        suggestionsDiv.innerHTML = matches.map(item => `
            <div class="suggestion-item" onclick="addItemToPack(${item.id}); clearSearch();">
                <div class="suggestion-main">
                    <span class="suggestion-name">${item.name}</span>
                    <span class="suggestion-weight">${item.weight}g</span>
                </div>
                <div class="suggestion-meta">
                    <span class="suggestion-category">${item.category}</span>
                    ${item.description ? `<span class="suggestion-description">${item.description}</span>` : ''}
                    ${item.inPack ? '<span class="suggestion-status">Already in pack</span>' : ''}
                </div>
            </div>
        `).join('');
        
        suggestionsDiv.style.display = 'block';
    });
    
    // Hide suggestions when clicking outside
    document.addEventListener('click', function(e) {
        if (!searchInput.contains(e.target) && !suggestionsDiv.contains(e.target)) {
            suggestionsDiv.style.display = 'none';
        }
    });
}

function clearSearch() {
    const searchInput = document.getElementById('addItemSearch');
    const suggestionsDiv = document.getElementById('itemSuggestions');
    
    if (searchInput) searchInput.value = '';
    if (suggestionsDiv) suggestionsDiv.style.display = 'none';
}

async function addItemToPack(itemId) {
    await fetchCSRFToken();
    
    const formData = new FormData();
    formData.append('item_id', itemId);
    formData.append('csrf_token', csrfToken);

    try {
        const response = await fetch(`/packs/${packId}/items`, {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRF-Token': csrfToken
            }
        });

        if (response.ok) {
            location.reload();
        } else {
            const data = await response.json();
            alert(data.error || 'Failed to add item to pack');
        }
    } catch (error) {
        alert('Failed to add item to pack');
    }
}

document.addEventListener('DOMContentLoaded', function() {
    setupItemSearch();
});

async function toggleWorn(packId, itemId, isWorn) {
    await fetchCSRFToken();
    
    const formData = new FormData();
    formData.append('is_worn', isWorn);
    formData.append('csrf_token', csrfToken);

    try {
        const response = await fetch(`/packs/${packId}/items/${itemId}/worn`, {
            method: 'PUT',
            body: formData,
            headers: {
                'X-CSRF-Token': csrfToken
            }
        });

        if (response.ok) {
            location.reload();
        } else {
            const data = await response.json();
            alert(data.error || 'Failed to update worn status');
            location.reload(); // Reload to reset checkbox state
        }
    } catch (error) {
        alert('Failed to update worn status');
        location.reload();
    }
}

async function updateWornCount(packId, itemId, wornCount) {
    await fetchCSRFToken();
    
    const formData = new FormData();
    formData.append('worn_count', wornCount);
    formData.append('csrf_token', csrfToken);

    try {
        const response = await fetch(`/packs/${packId}/items/${itemId}/worn-count`, {
            method: 'PUT',
            body: formData,
            headers: {
                'X-CSRF-Token': csrfToken
            }
        });

        if (response.ok) {
            location.reload();
        } else {
            const data = await response.json();
            alert(data.error || 'Failed to update worn count');
            location.reload(); // Reload to reset input value
        }
    } catch (error) {
        alert('Failed to update worn count');
        location.reload();
    }
}

async function removeFromPack(packId, itemId) {
    if (!confirm('Are you sure you want to remove this item from the pack?')) {
        return;
    }

    await fetchCSRFToken();
    
    try {
        const response = await fetch(`/packs/${packId}/items/${itemId}`, {
            method: 'DELETE',
            headers: {
                'X-CSRF-Token': csrfToken
            }
        });

        if (response.ok) {
            location.reload();
        } else {
            const data = await response.json();
            alert(data.error || 'Failed to remove item');
        }
    } catch (error) {
        alert('Failed to remove item');
    }
}

// Chart.js for weight visualization
{{if .CategoryWeights}}
const ctx = document.getElementById('weightChart').getContext('2d');
const chartData = {
    labels: [{{range $category, $weight := .CategoryWeights}}'{{$category}} ({{$weight}}g)',{{end}}],
    datasets: [{
        data: [{{range $category, $weight := .CategoryWeights}}{{$weight}},{{end}}],
        backgroundColor: [
            '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40'
        ]
    }]
};

new Chart(ctx, {
    type: 'doughnut',
    data: chartData,
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                position: 'bottom'
            },
            title: {
                display: true,
                text: 'Weight Distribution by Category'
            }
        }
    }
});
{{end}}

</script>
    </main>

    <footer class="footer">
        <p>&copy; 2025 Carryless. Built for outdoor enthusiasts.</p>
    </footer>

    <script src="/static/js/app.js"></script>
</body>
</html>
{{end}}