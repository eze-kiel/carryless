{{define "public_pack.html"}}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{.Title}}</title>
    <link rel="stylesheet" href="/static/css/style.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <header class="header">
        <nav class="nav">
            <div class="nav-brand">
                <a href="/">Carryless</a>
            </div>
            <div class="nav-links">
                {{if .User}}
                    <a href="/dashboard">Dashboard</a>
                    <a href="/inventory">Inventory</a>
                    <a href="/categories">Categories</a>
                    <a href="/packs">Packs</a>
                    {{if .User.IsAdmin}}
                        <a href="/admin">Admin</a>
                    {{end}}
                    <a href="/account">Account</a>
                    <form class="logout-form" action="/logout" method="POST">
                        <button type="submit" class="btn btn-secondary">Logout</button>
                    </form>
                {{else}}
                    <a href="/login">Login</a>
                    <a href="/register">Register</a>
                {{end}}
            </div>
        </nav>
    </header>

    <main class="main">
        {{if .Error}}
            <div class="alert alert-error">{{.Error}}</div>
        {{end}}
        
        <div class="pack-detail">
            <div class="pack-header">
                <h1>{{.Pack.Name}} <span class="badge">Public Pack</span></h1>
                
                <div class="pack-stats">
                    <div class="stat">
                        <div class="stat-value" data-weight="{{.TotalWeight}}">{{.TotalWeight}}g</div>
                        <div class="stat-label">Pack Weight</div>
                    </div>
                    <div class="stat">
                        <div class="stat-value" data-weight="{{.TotalWornWeight}}">{{.TotalWornWeight}}g</div>
                        <div class="stat-label">Worn Weight</div>
                    </div>
                    <div class="stat">
                        <div class="stat-value" data-weight="{{add .TotalWeight .TotalWornWeight}}">{{add .TotalWeight .TotalWornWeight}}g</div>
                        <div class="stat-label">Total Weight</div>
                    </div>
                    <div class="stat">
                        <div class="stat-value">{{.TotalItemCount}}</div>
                        <div class="stat-label">Items</div>
                    </div>
                </div>

                {{if .CategoryWeights}}
                    <div class="chart-container">
                        <canvas id="weightChart"></canvas>
                    </div>
                {{end}}
            </div>

            {{if .Pack.Items}}
                {{$categoryWeights := .CategoryWeights}}
                {{$categoryWornWeights := .CategoryWornWeights}}
                {{range $category, $items := (groupByCategory .Pack.Items)}}
                    <div class="category-section">
                        <h3>{{$category}} 
                            ({{index $categoryWeights $category}}g
                            {{if index $categoryWornWeights $category}}
                                + {{index $categoryWornWeights $category}}g worn
                            {{end}})
                        </h3>
                        <table>
                            <thead>
                                <tr>
                                    <th>Item</th>
                                    <th>Description</th>
                                    <th>Weight</th>
                                    <th>Worn</th>
                                </tr>
                            </thead>
                            <tbody>
                                {{range $items}}
                                    <tr {{if .IsWorn}}class="worn-item"{{end}}>
                                        <td>{{.Item.Name}}</td>
                                        <td>{{.Item.Note}}</td>
                                        <td><span data-weight="{{.Item.WeightGrams}}">{{.Item.WeightGrams}}g</span></td>
                                        <td>{{if .IsWorn}}âœ“{{end}}</td>
                                    </tr>
                                {{end}}
                            </tbody>
                        </table>
                    </div>
                {{end}}
            {{else}}
                <div class="empty-state">
                    <p>This pack has no items.</p>
                </div>
            {{end}}
        </div>

<script>
    // Chart.js for weight visualization
    {{if .CategoryWeights}}
    let weightChart;
    const categoryData = {
        {{range $category, $weight := .CategoryWeights}}
        "{{$category}}": {{$weight}},
        {{end}}
    };

    function createWeightChart(unit = 'g') {
        const ctx = document.getElementById('weightChart');
        if (!ctx) return;
        
        // Destroy existing chart if it exists
        if (weightChart) {
            weightChart.destroy();
        }
        
        const labels = [];
        const data = [];
        
        for (const [category, grams] of Object.entries(categoryData)) {
            labels.push(category + ' (' + formatWeightWithUnit(grams, unit) + ')');
            data.push(grams);
        }
        
        const chartData = {
            labels: labels,
            datasets: [{
                data: data,
                backgroundColor: [
                    '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40'
                ]
            }]
        };

        weightChart = new Chart(ctx, {
            type: 'doughnut',
            data: chartData,
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom'
                    },
                    title: {
                        display: true,
                        text: 'Weight Distribution by Category'
                    }
                }
            }
        });
    }
    {{end}}
    
    // Weight unit conversion functions
    function gramsToOunces(grams) {
        return (grams * 0.035274).toFixed(2);
    }

    function formatWeightWithUnit(grams, unit) {
        if (unit === 'oz') {
            const oz = gramsToOunces(grams);
            return oz + 'oz';
        }
        return grams + 'g';
    }

    // Cookie management
    function setCookie(name, value, days = 365) {
        const expires = new Date();
        expires.setTime(expires.getTime() + (days * 24 * 60 * 60 * 1000));
        document.cookie = name + '=' + value + ';expires=' + expires.toUTCString() + ';path=/';
    }

    function getCookie(name) {
        const nameEQ = name + "=";
        const ca = document.cookie.split(';');
        for (let i = 0; i < ca.length; i++) {
            let c = ca[i];
            while (c.charAt(0) === ' ') c = c.substring(1, c.length);
            if (c.indexOf(nameEQ) === 0) return c.substring(nameEQ.length, c.length);
        }
        return null;
    }

    // Weight unit conversion
    function convertWeightDisplays(unit) {
        // Convert all weight displays on the page
        const weightElements = document.querySelectorAll('[data-weight]');
        weightElements.forEach(element => {
            const grams = parseInt(element.dataset.weight);
            element.textContent = formatWeightWithUnit(grams, unit);
        });
        
        // Convert statistics (using data-weight attributes for accurate conversion)
        const statElements = document.querySelectorAll('.stat-value[data-weight]');
        statElements.forEach(element => {
            const grams = parseInt(element.dataset.weight);
            if (!isNaN(grams)) {
                element.textContent = formatWeightWithUnit(grams, unit);
            }
        });
        
        // Convert category headers
        const categoryHeaders = document.querySelectorAll('.category-section h3');
        categoryHeaders.forEach(header => {
            const text = header.textContent;
            const gramsMatch = text.match(/(\d+)g/g);
            if (gramsMatch) {
                let newText = text;
                gramsMatch.forEach(match => {
                    const grams = parseInt(match.replace('g', ''));
                    const converted = formatWeightWithUnit(grams, unit);
                    newText = newText.replace(match, converted);
                });
                header.textContent = newText;
            }
        });
        
        // Update chart if it exists
        {{if .CategoryWeights}}
        if (typeof createWeightChart === 'function') {
            createWeightChart(unit);
        }
        {{end}}
    }

    // Validate weight unit value
    function isValidWeightUnit(unit) {
        return unit === 'g' || unit === 'oz';
    }

    function changeWeightUnit(unit) {
        // Validate unit before setting
        if (!isValidWeightUnit(unit)) {
            console.warn('Invalid weight unit:', unit, 'Defaulting to grams');
            unit = 'g';
        }
        
        setCookie('weightUnit', unit);
        convertWeightDisplays(unit);
    }

    // Initialize unit preference on page load
    document.addEventListener('DOMContentLoaded', function() {
        let savedUnit = getCookie('weightUnit') || 'g';
        
        // Validate cookie value, default to grams if invalid
        if (!isValidWeightUnit(savedUnit)) {
            savedUnit = 'g';
            setCookie('weightUnit', 'g'); // Reset cookie to valid value
        }
        
        const selector = document.getElementById('weightUnitSelector');
        if (selector) {
            selector.value = savedUnit;
        }
        
        // Initialize chart and convert displays with correct unit
        {{if .CategoryWeights}}
        createWeightChart(savedUnit);
        {{end}}
        
        if (savedUnit === 'oz') {
            convertWeightDisplays('oz');
        }
    });
    </script>

<style>
    .badge {
        background: #007bff;
        color: white;
        padding: 0.25rem 0.5rem;
        border-radius: 4px;
        font-size: 0.75rem;
        font-weight: normal;
    }

    .worn-item {
        background-color: #f8f9fa;
        font-style: italic;
    }

    .category-section {
        background: white;
        margin: 1rem 0;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        overflow: hidden;
    }

    .category-section h3 {
        background: #f8f9fa;
        padding: 1rem;
        margin: 0;
        color: #2c3e50;
        border-bottom: 1px solid #e9ecef;
    }

    .category-section table {
        width: 100%;
        border-collapse: collapse;
    }

    .category-section th,
    .category-section td {
        padding: 1rem;
        text-align: left;
        border-bottom: 1px solid #e9ecef;
    }

    .category-section th {
        background-color: #f8f9fa;
        font-weight: 600;
        color: #495057;
    }
    </style>
    </main>

    <footer class="footer">
        <div class="footer-content">
            <p>&copy; 2025 Carryless. Built for outdoor enthusiasts.</p>
            <div class="weight-unit-selector">
                <label for="weightUnitSelector">Units:</label>
                <select id="weightUnitSelector" onchange="changeWeightUnit(this.value)">
                    <option value="g">Grams</option>
                    <option value="oz">Ounces</option>
                </select>
            </div>
        </div>
    </footer>

    <script src="/static/js/app.js"></script>
</body>
</html>
{{end}}